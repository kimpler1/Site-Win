#!/bin/bash

echo "üîß –ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞..."

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã PM2
echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ PM2..."
pm2 stop all
pm2 delete all

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–µ—à–∏ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
echo "–û—á–∏—Å—Ç–∫–∞ –∫–µ—à–µ–π..."
rm -rf .next
rm -rf node_modules/.cache
rm -rf .swc
rm -rf dist

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
chown -R root:root /var/www/arlekino
chmod -R 755 /var/www/arlekino

# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "–ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm ci --force

# –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
echo "–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏
if [ -d ".next" ] && [ -f ".next/BUILD_ID" ]; then
    echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞!"
    
    # –ó–∞–ø—É—Å—Ç–∏—Ç—å PM2
    echo "–ó–∞–ø—É—Å–∫ PM2..."
    pm2 start npm --name "arlekino" -- start
    
    # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
    pm2 status
    
    echo "üéâ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: http://91.92.43.69"
    echo "–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: http://91.92.43.69/admin"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
    npm run build
fi
